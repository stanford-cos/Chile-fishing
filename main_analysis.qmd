---
title: "Chile VMS Exploritory Analysis"
author: 
  - name: Althea Marks
    orcid: 0000-0002-9370-9128
    email: amarks1@stanford.edu
    affiliations:
      - name: Stanford Center for Ocean Solutions
date: "`r Sys.Date()`"
format: 
  html: 
    number-sections: true
    toc: true
    code-tools: true
    theme: cosmo 
    self-contained: true
    page-layout: full
---

```{r setup, include=FALSE}
# Code chunk setup options
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE)

# libraries
library(readr)
library(bigrquery)

# directories
data_dir <- file.path("./data")
out_dir <- file.path("./output")
scripts_dir <- file.path("./scripts")

# Import data from  bq_gfw_query.sql
fish_data <- read_csv(file.path(data_dir, "gfw_research_positions_2023_07_03.csv"))
port_coords <- read_csv(file.path(data_dir, "port_coordinates.csv"))

source(file.path(scripts_dir, "functions.R"))
```


# Map Individual Vessels

Date Range: 2023-05-01 to 2023-05-15
```{r make_maps}
map_list <- list()

for (i in 1:10){
   a_vessel <- get_one_vessel(fish_data,i)
   map_list[[i]] <- map_one_vessel(a_vessel)
}

```

1) ssvid `r get_one_ssvid(fish_data,1)`
```{r map_1}
map_list[[1]]
```
------------------

2) ssvid `r get_one_ssvid(fish_data,2)`
```{r}
map_list[[2]]
```
-------------------

3) ssvid `r get_one_ssvid(fish_data,3)`
```{r}
map_list[[3]]
```
-------------------

4) ssvid `r get_one_ssvid(fish_data,4)`
```{r}
map_list[[4]]
```
-------------------

5) ssvid `r get_one_ssvid(fish_data,5)`
```{r}
map_list[[5]]
```
-------------------

6) ssvid `r get_one_ssvid(fish_data,6)`
```{r}
map_list[[6]]
```
-------------------

7) ssvid `r get_one_ssvid(fish_data,7)`
```{r}
map_list[[7]]
```
-------------------

8) ssvid `r get_one_ssvid(fish_data,8)`
```{r}
map_list[[8]]
```
-------------------

9) ssvid `r get_one_ssvid(fish_data,9)`
```{r}
map_list[[9]]
```
-------------------

10) ssvid `r get_one_ssvid(fish_data,10)`
```{r}
map_list[[10]]
```

# Fishing Hours Heat Map

Using GFW map is the best option for large amounts of data.

# PSMA Top 10 Pacific Ports

```{r}
read_in_ocean("pacific")
read_in_ocean("south_china_sea")
```

```{r}
# can combine simple features of the same class - 
# would pacific (multipolygon) & south china sea (polygon) work
total_pacific <- st_sfc(pacific, south_china_sea)
```


# Connect to GFW BigQuery

not working yet
```{r connect_BigQuery, eval=FALSE}

library(DBI)
library(bigrquery)

#### Question 
# Do I need a service account to make authentification automatic/stored in local environment? Current code required redirecting to browser to authenticate account.

# Use environmental variable to point to service key for authentication
#api_key <- file.path(Sys.getenv("bg_marks_key"))

#bigrquery::bq_auth()

# establish connection
con <- DBI::dbConnect(
  bigrquery::bigquery(),
  project = "world-fishing-827",
  dataset = "pipe_chile_production_v20211126",
  billing = "ssds-scrt-marks",
  use_legacy_sql = FALSE
)


# list tables - promps browser login window
length(dbListTables(con))

# show how R gets translated into SQL, include in pipe
# dplyr::show_query
```

```{r get_marine_boundaries}
library(mregions)
library(sf)

# search for geo codes & names
test <- mr_geo_code(place = "easter", like = TRUE, fuzzy = FALSE)

# Get shape file
easter_island_eez <- mregions::mr_shp(key = "MarineRegions:eez",
                                      filter = "Chilean Exclusive Economic Zone (Easter Island)",
                                      maxFeatures = 200) # what is maxFeatures? number of features
# check shp is what we expect
library(leaflet)
leaflet() %>%
  addTiles() %>%
  addPolygons(data = easter_island_eez)

##############################
## Next step is to integrate boundary into SQL query

# Below is from Juan's example

# transform the shapefile into an sf object
easter_island_eez_sf <- easter_island_eez %>% 
  sf::st_as_sf()

# get the bounding box of the shapefile
easter_island_bbox <- sf::st_bbox(easter_island_eez_sf)

# extend the bounding box 1 degree in every direction.
min_lon <- azores_bbox[["xmin"]] - 1 
max_lon <- azores_bbox[["xmax"]] + 1
min_lat <- azores_bbox[["ymin"]] - 1
max_lat <- azores_bbox[["ymax"]] + 1 

# define mapping resoluion in degrees
resolution <- 0.1

# convert shp to WKT
#mr_as_wkt(easter_island_eez, fmt = 5)

```

SQL query from Juan Mayorga's tuturial

```{sql connection = BQ_connection, output.var = "binned_effort_around_Azores", echo = FALSE}
SELECT
  FLOOR(lat_bin/?resolution)*?resolution + 0.5*?resolution lat_bin_center,
  FLOOR(lon_bin/?resolution)*?resolution + 0.5*?resolution lon_bin_center,
  SUM(fishing_hours) fishing_hours
FROM (
  SELECT
    lat_bin/100 lat_bin,
    lon_bin/100 lon_bin,
    fishing_hours
  FROM
    `global-fishing-watch.global_footprint_of_fisheries.fishing_effort`
  WHERE
    _PARTITIONTIME >= '2016-01-01 00:00:00'
    AND _PARTITIONTIME < '2016-12-31 00:00:00')
  WHERE 
  lat_bin >= ?min_lat
  AND lat_bin <= ?max_lat
  AND lon_bin >= ?min_lon
  AND lon_bin <= ?max_lon
GROUP BY
  lat_bin_center,
  lon_bin_center
HAVING 
  fishing_hours > 0
```
